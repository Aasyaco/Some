name: Build Full CPython Bundle on Ubuntu

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Git
        run: sudo apt-get update && sudo apt-get install -y git

      - name: Clone CPython Repository
        run: git clone --branch 3.13 --depth 1 https://github.com/python/cpython.git

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \
            libbz2-dev libreadline-dev libsqlite3-dev curl libncursesw5-dev \
            xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev

      - name: Configure CPython
        working-directory: ./cpython
        run: ./configure --enable-optimizations

      - name: Build CPython
        working-directory: ./cpython
        run: make -j$(nproc)

      - name: Prepare Full CPython Bundle
        working-directory: ./cpython
        run: |
          mkdir -p ../cpython-full-bundle
          cp python ../cpython-full-bundle/
          cp -r Lib Include Modules config.c ./python-config* ../cpython-full-bundle/ || true
          cp -r build ../cpython-full-bundle/ || true
          find . -name "libpython*.so*" -exec cp {} ../cpython-full-bundle/ \;

      - name: Create ZIP Archive
        run: |
          zip -r cpython-full.zip cpython-full-bundle

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cpython-full
          path: cpython-full.zip

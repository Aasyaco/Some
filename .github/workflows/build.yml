name: Build Android

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - '3.*'
  pull_request:
    branches:
      - main
      - '3.*'

jobs:
  build-android-313:
    name: Android (aarch64) Python 3.13
    runs-on: macos-14
    timeout-minutes: 60
    env:
      PATH: /opt/homebrew/opt/llvm@21/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
      LDFLAGS: -L/opt/homebrew/opt/llvm@21/lib
      CPPFLAGS: -I/opt/homebrew/opt/llvm@21/include
      CC: clang
      CXX: clang++
    steps:
      - name: Ensure Homebrew is in PATH
        run: |
          echo "HOMEBREW_PREFIX=/opt/homebrew" >> $GITHUB_ENV
          echo "HOMEBREW_CELLAR=/opt/homebrew/Cellar" >> $GITHUB_ENV
          echo "HOMEBREW_REPOSITORY=/opt/homebrew" >> $GITHUB_ENV
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          echo "/opt/homebrew/sbin" >> $GITHUB_PATH

      - name: Install dependencies & clone CPython
        run: |
          brew install readline lld dpkg mpdecimal llvm@21
          brew link llvm@21 --force
          git clone --branch 3.13 --depth 1 https://github.com/python/cpython.git cpython-3.13
          ls cpython-3.13
          clang --version

      - name: Apply patch and prepare Android scripts
        working-directory: ./cpython-3.13
        run: |
          curl -L https://raw.githubusercontent.com/yubrajbhoi/termux-python/refs/heads/main/termux.patch -o termux.patch
          curl -L https://raw.githubusercontent.com/Aasyaco/Some/refs/heads/main/android.py -o android.py
          git apply termux.patch
          mkdir -p Android
          cp android.py Android/

      - name: Install cross-compiled libraries
        working-directory: ./cpython-3.13
        run: |
          PREFIX="$PWD/cross-build/aarch64-linux-android/prefix"
          mkdir -p $PREFIX
          cd $PREFIX
          curl -L -O https://github.com/beeware/cpython-android-source-deps/releases/download/bzip2-1.0.8-3/bzip2-1.0.8-3-aarch64-linux-android.tar.gz
          tar -xzf bzip2-1.0.8-3-aarch64-linux-android.tar.gz
          curl -L -O https://github.com/beeware/cpython-android-source-deps/releases/download/xz-5.4.6-1/xz-5.4.6-1-aarch64-linux-android.tar.gz
          tar -xzf xz-5.4.6-1-aarch64-linux-android.tar.gz
          curl -L -O https://zlib.net/current/zlib.tar.gz
          tar -xzf zlib.tar.gz
          cd zlib-1.3.1
          CC=/Users/runner/Library/Android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android21-clang \
          AR=aarch64-linux-android-ar \
          RANLIB=aarch64-linux-android-ranlib \
          ./configure --prefix=$PREFIX
          make -j$(nproc)
          make install
          cd $PREFIX
          export LDFLAGS="-L$PREFIX/bzip2-1.0.8-3/lib -L$PREFIX/xz-5.4.6-1/lib -L$PREFIX/lib"
          export CPPFLAGS="-I$PREFIX/bzip2-1.0.8-3/include -I$PREFIX/xz-5.4.6-1/include -I$PREFIX/include"
          export PKG_CONFIG_PATH="$PREFIX/bzip2-1.0.8-3/lib/pkgconfig:$PREFIX/xz-5.4.6-1/lib/pkgconfig:$PREFIX/lib/pkgconfig"


      - name: Build CPython for Android
        working-directory: ./cpython-3.13/Android
        run: |
          mkdir -p ../cross-build/build
          ./android.py clean || true
          ./android.py ci aarch64-linux-android
          python3.13 -c "import sys; print(sys.version)" || echo 'Python not found'
          
      - name: Build CPython for Android
        working-directory: ./cpython-3.13/Android
        run: |
          mkdir -p ../cross-build/build
          ./android.py clean || true
          ./android.py ci aarch64-linux-android
          python3.13 -c "import sys; print(sys.version)" || echo 'Python not found'

      - name: Package as .deb
        run: |
          export CPPFLAGS="-I/opt/homebrew/opt/llvm@21/include"
          export LDFLAGS="-L/opt/homebrew/opt/llvm@21/lib -L/opt/homebrew/opt/llvm@21/lib/unwind -L/opt/homebrew/opt/llvm@21/lib/c++ -lunwind"
          PKG_NAME="pyv313"
          PKG_VERSION="3.13"
          ARCH="aarch64"
          DEB_DIR="$PKG_NAME"
          BUILD_DIR="./cpython-3.13/cross-build/aarch64-linux-android"

          mkdir -p $DEB_DIR/DEBIAN
          mkdir -p $DEB_DIR/usr
          cat > $DEB_DIR/DEBIAN/control <<EOF
          Package: $PKG_NAME
          Version: $PKG_VERSION
          Architecture: $ARCH
          Maintainer: Cross-compiled by NotFound
          Description: Python 3.13 cross-compiled for Termux aarch64
          EOF

          cat > $DEB_DIR/DEBIAN/postinst <<'EOF'
          #!/bin/sh
          set -e
          echo "pyv313 installed successfully!"
          exit 0
          EOF
          chmod 755 $DEB_DIR/DEBIAN/postinst

          if [ -d "$BUILD_DIR/prefix" ]; then
            cp -r $BUILD_DIR/prefix/* $DEB_DIR/usr/
          elif [ -d "$BUILD_DIR/install" ]; then
            cp -r $BUILD_DIR/install/* $DEB_DIR/usr/
          else
            ls $BUILD_DIR
            echo "No prefix/ or install/ directory found in $BUILD_DIR"
            exit 1
          fi

          dpkg-deb --build $DEB_DIR ${PKG_NAME}_${PKG_VERSION}_${ARCH}.deb

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: pyv313
          path: pyv313_3.13_aarch64.deb
          if-no-files-found: error
